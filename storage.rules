rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // 인증된 사용자만 접근 가능
    function isAuthenticated() {
      return request.auth != null;
    }

    // 본인 확인
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // 이미지 파일 검증 (10MB 이하 - 클라이언트에서 압축하지만 여유 확보)
    function isValidImage() {
      return request.resource.size < 10 * 1024 * 1024 &&
        request.resource.contentType.matches('image/.*');
    }

    // 일반 파일 검증 (10MB 이하)
    function isValidFile() {
      return request.resource.size < 10 * 1024 * 1024;
    }

    // 게시글 이미지 저장 경로
    match /posts/{userId}/{fileName} {
      // 읽기: 모든 인증된 사용자
      allow read: if isAuthenticated();

      // 쓰기: 본인만 + 유효한 이미지
      allow write: if isOwner(userId) && isValidImage();

      // 삭제: 본인만
      allow delete: if isOwner(userId);
    }

    // 첨부 파일 저장 경로
    match /files/{userId}/{fileName} {
      // 읽기: 모든 인증된 사용자
      allow read: if isAuthenticated();

      // 쓰기: 본인만 + 유효한 파일
      allow write: if isOwner(userId) && isValidFile();

      // 삭제: 본인만
      allow delete: if isOwner(userId);
    }

    // 프로필 이미지 저장 경로
    match /profiles/{userId}/{fileName} {
      // 읽기: 모든 인증된 사용자
      allow read: if isAuthenticated();

      // 쓰기: 본인만 + 유효한 이미지
      allow write: if isOwner(userId) && isValidImage();

      // 삭제: 본인만
      allow delete: if isOwner(userId);
    }

    // 퀴즈 문제 이미지 저장 경로
    match /quiz-images/{userId}/{fileName} {
      // 읽기: 모든 인증된 사용자
      allow read: if isAuthenticated();

      // 쓰기: 본인만 + 유효한 이미지
      allow write: if isOwner(userId) && isValidImage();

      // 삭제: 본인만
      allow delete: if isOwner(userId);
    }

    // PPTX 업로드 경로 (Cloud Run 퀴즈 생성용)
    match /pptx-uploads/{userId}/{fileName} {
      // PPTX 파일 검증 (50MB 이하)
      function isValidPptx() {
        return request.resource.size < 50 * 1024 * 1024 &&
          (request.resource.contentType == 'application/vnd.openxmlformats-officedocument.presentationml.presentation' ||
           fileName.matches('.*\\.pptx$'));
      }

      // 읽기: 본인만 (Cloud Run은 서비스 계정으로 접근)
      allow read: if isOwner(userId);

      // 쓰기: 본인만 + 유효한 PPTX
      allow write: if isOwner(userId) && isValidPptx();

      // 삭제: 본인만 (Cloud Run에서 처리 후 삭제)
      allow delete: if isOwner(userId);
    }
  }
}
