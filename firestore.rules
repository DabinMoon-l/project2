rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // 헬퍼 함수
    // ============================================================

    // 로그인 여부 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 본인 확인
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // 교수님 여부 확인
    function isProfessor() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'professor';
    }

    // 문자열 길이 검증
    function isValidString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }

    // ============================================================
    // 사용자 컬렉션
    // ============================================================

    match /users/{uid} {
      // 읽기: 본인 또는 교수님
      allow read: if isOwner(uid) || isProfessor();

      // 생성: 본인만 (온보딩 시 또는 교수님 첫 로그인)
      allow create: if isOwner(uid);

      // 수정: 본인만 (일부 필드만)
      // exp, rank 등은 Cloud Functions에서만 수정 가능
      allow update: if isOwner(uid) &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['totalExp', 'rank', 'role', 'badges']);

      // 삭제: 불가
      allow delete: if false;

      // 퀴즈 기록 서브컬렉션
      match /quizHistory/{quizId} {
        allow read: if isOwner(uid) || isProfessor();
        allow write: if false; // Cloud Functions에서만 작성
      }
    }

    // ============================================================
    // 퀴즈 컬렉션
    // ============================================================

    match /quizzes/{quizId} {
      // 읽기: 로그인 사용자는 모든 퀴즈 읽기 가능 (목록 조회를 위해)
      allow read: if isAuthenticated();

      // 생성: 교수님 또는 로그인 사용자 (자체제작 퀴즈)
      allow create: if isAuthenticated() &&
        (isProfessor() ||
         (request.resource.data.type == 'custom' &&
          request.resource.data.creatorId == request.auth.uid));

      // 수정: 교수님 또는 본인이 만든 자체제작 퀴즈 또는 completedUsers만 수정
      allow update: if isAuthenticated() &&
        (isProfessor() ||
         (resource.data.type == 'custom' &&
          resource.data.creatorId == request.auth.uid) ||
         // 로그인 사용자가 completedUsers만 수정하는 경우 허용
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['completedUsers']));

      // 삭제: 교수님 또는 본인이 만든 자체제작 퀴즈
      allow delete: if isProfessor() ||
        (resource.data.type == 'custom' && resource.data.creatorId == request.auth.uid);

      // 퀴즈 제출 서브컬렉션
      match /submissions/{submissionId} {
        allow read: if isOwner(resource.data.userId) || isProfessor();
        allow create: if isAuthenticated() &&
          request.resource.data.userId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    // ============================================================
    // 게시판 컬렉션
    // ============================================================

    match /posts/{postId} {
      // 읽기: 모든 로그인 사용자
      allow read: if isAuthenticated();

      // 생성: 로그인 사용자 (유효성 검증)
      allow create: if isAuthenticated() &&
        request.resource.data.authorId == request.auth.uid &&
        isValidString(request.resource.data.title, 1, 100) &&
        isValidString(request.resource.data.content, 1, 5000) &&
        request.resource.data.category in ['toProfessor', 'community'];

      // 수정: 작성자가 제목/내용 수정 OR 로그인 사용자가 좋아요/댓글수 업데이트
      allow update: if isAuthenticated() && (
        // 작성자가 제목, 내용, 이미지, 파일 수정
        (isOwner(resource.data.authorId) &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['title', 'content', 'imageUrl', 'imageUrls', 'fileUrls', 'isAnonymous', 'updatedAt'])) ||
        // 로그인 사용자가 좋아요/댓글수 업데이트
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['likes', 'likedBy', 'commentCount'])
      );

      // 삭제: 작성자 또는 교수님
      allow delete: if isOwner(resource.data.authorId) || isProfessor();

      // 댓글 서브컬렉션
      match /comments/{commentId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated() &&
          request.resource.data.authorId == request.auth.uid &&
          isValidString(request.resource.data.content, 1, 1000);

        allow update: if isOwner(resource.data.authorId) &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['content', 'updatedAt']);

        allow delete: if isOwner(resource.data.authorId) || isProfessor();
      }
    }

    // ============================================================
    // 댓글 컬렉션 (최상위)
    // ============================================================

    match /comments/{commentId} {
      // 읽기: 모든 로그인 사용자
      allow read: if isAuthenticated();

      // 생성: 로그인 사용자 (유효성 검증)
      allow create: if isAuthenticated() &&
        request.resource.data.authorId == request.auth.uid &&
        isValidString(request.resource.data.content, 1, 1000);

      // 수정: 작성자가 내용 수정 OR 로그인 사용자가 좋아요 업데이트
      allow update: if isAuthenticated() && (
        // 작성자가 내용 수정
        (isOwner(resource.data.authorId) &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['content', 'updatedAt'])) ||
        // 로그인 사용자가 좋아요 업데이트 (likes, likedBy 필드만 변경)
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['likes', 'likedBy'])
      );

      // 삭제: 작성자 또는 교수님
      allow delete: if isOwner(resource.data.authorId) || isProfessor();
    }

    // ============================================================
    // 피드백 컬렉션
    // ============================================================

    match /feedbacks/{feedbackId} {
      // 읽기: 로그인 사용자 (퀴즈 제작자가 피드백 확인용, 민감하지 않은 데이터)
      allow read: if isAuthenticated();

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 교수님만 (답변 작성)
      allow update: if isProfessor();

      // 삭제: 불가
      allow delete: if false;
    }

    // ============================================================
    // 도배 방지 (Rate Limit) 컬렉션
    // ============================================================

    match /rateLimits/{uid} {
      allow read, write: if isOwner(uid);

      match /{type}/{recordId} {
        allow read, write: if isOwner(uid);
      }
    }

    // ============================================================
    // FCM 토큰 컬렉션
    // ============================================================

    match /fcmTokens/{tokenId} {
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow create, update: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 시즌 로그 컬렉션
    // ============================================================

    match /seasonLogs/{logId} {
      // 읽기: 교수님만
      allow read: if isProfessor();

      // 쓰기: Cloud Functions에서만
      allow write: if false;
    }

    // ============================================================
    // 알림 컬렉션
    // ============================================================

    match /notifications/{notificationId} {
      // 읽기: 본인 알림만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 수정: 본인만 (읽음 처리)
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);

      // 생성/삭제: Cloud Functions에서만
      allow create, delete: if false;
    }

    // ============================================================
    // 복습 문제 컬렉션 (오답/찜한 문제)
    // ============================================================

    match /reviews/{reviewId} {
      // 읽기: 본인 문제만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만 (복습 횟수, 마지막 복습 일시)
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 퀴즈 결과 컬렉션 (푼 문제)
    // ============================================================

    match /quizResults/{resultId} {
      // 읽기: 로그인 사용자 (통계 조회용, 민감하지 않은 데이터)
      allow read: if isAuthenticated();

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만 (피드백 여부 등)
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만 (푼 문제 폴더 삭제 시)
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 커스텀 폴더 컬렉션 (내맘대로)
    // ============================================================

    match /customFolders/{folderId} {
      // 읽기: 본인 폴더만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 문제 피드백 컬렉션
    // ============================================================

    match /questionFeedbacks/{feedbackId} {
      // 읽기: 본인 피드백, 교수님, 또는 해당 퀴즈의 제작자
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isProfessor() ||
         // 퀴즈 제작자도 피드백 확인 가능
         (resource.data.quizId != null &&
          get(/databases/$(database)/documents/quizzes/$(resource.data.quizId)).data.creatorId == request.auth.uid));

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정/삭제: 불가
      allow update, delete: if false;
    }

    // ============================================================
    // 퀴즈 진행 상황 저장 컬렉션
    // ============================================================

    match /quizProgress/{progressId} {
      // 읽기: 본인만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 퀴즈 제출 컬렉션 (최상위)
    // ============================================================

    match /submissions/{submissionId} {
      // 읽기: 본인 또는 교수님
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isProfessor());

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정/삭제: 불가
      allow update, delete: if false;
    }

    // ============================================================
    // 퀴즈 북마크 컬렉션 (찜한 문제지)
    // ============================================================

    match /quizBookmarks/{bookmarkId} {
      // 읽기: 본인 북마크만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 과목 컬렉션 (읽기 전용)
    // ============================================================

    match /courses/{courseId} {
      // 읽기: 모든 로그인 사용자
      allow read: if isAuthenticated();

      // 쓰기: 교수님만
      allow write: if isProfessor();
    }

    // ============================================================
    // 설정 컬렉션 (학기 설정 등)
    // ============================================================

    match /settings/{settingId} {
      // 읽기: 모든 로그인 사용자
      allow read: if isAuthenticated();

      // 쓰기: 교수님만
      allow write: if isProfessor();
    }
  }
}
