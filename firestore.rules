rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // 헬퍼 함수
    // ============================================================

    // 로그인 여부 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 본인 확인
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // 교수님 여부 확인
    function isProfessor() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'professor';
    }

    // 문자열 길이 검증
    function isValidString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }

    // ============================================================
    // 사용자 컬렉션
    // ============================================================

    match /users/{uid} {
      // 개별 읽기: 본인 또는 교수님
      allow get: if isOwner(uid) || isProfessor();
      // 목록 쿼리: 로그인 사용자 (랭킹 조회용)
      allow list: if isAuthenticated();

      // 생성: 본인만 (온보딩 시 또는 교수님 첫 로그인)
      allow create: if isOwner(uid);

      // 수정: 본인만 (일부 필드만)
      // exp, rank 등은 Cloud Functions에서만 수정 가능
      allow update: if isOwner(uid) &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['totalExp', 'rank', 'role', 'badges', 'equippedRabbits', 'totalCorrect', 'totalAttemptedQuestions', 'professorQuizzesCompleted', 'lastGachaExp']);

      // 삭제: 불가
      allow delete: if false;

      // 퀴즈 기록 서브컬렉션
      match /quizHistory/{quizId} {
        allow read: if isOwner(uid) || isProfessor();
        allow write: if false; // Cloud Functions에서만 작성
      }

      // 경험치 히스토리 서브컬렉션 (CF 전용 쓰기)
      match /expHistory/{historyId} {
        allow read: if isOwner(uid) || isProfessor();
        allow write: if false;
      }

      // 토끼 보유 서브컬렉션 (CF 전용 쓰기, 본인/교수 읽기)
      match /rabbitHoldings/{holdingId} {
        allow read: if isOwner(uid) || isProfessor();
        allow write: if false;
      }
    }

    // ============================================================
    // 퀴즈 컬렉션
    // ============================================================

    match /quizzes/{quizId} {
      // 읽기: 로그인 사용자는 모든 퀴즈 읽기 가능 (목록 조회를 위해)
      allow read: if isAuthenticated();

      // 생성: 교수님 또는 로그인 사용자 (자체제작/AI생성 퀴즈)
      allow create: if isAuthenticated() &&
        (isProfessor() ||
         (request.resource.data.type in ['custom', 'ai-generated'] &&
          request.resource.data.creatorId == request.auth.uid));

      // 수정: 교수님 또는 본인이 만든 자체제작/AI생성 퀴즈 또는 퀴즈 완료/찜 관련 필드만 수정
      allow update: if isAuthenticated() &&
        (isProfessor() ||
         (resource.data.type in ['custom', 'ai-generated'] &&
          resource.data.creatorId == request.auth.uid) ||
         // 로그인 사용자가 퀴즈 완료/통계 관련 필드만 수정하는 경우 허용
         // completedUsers, userScores, userFirstReviewScores, participantCount, bookmarkCount
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['completedUsers', 'userScores', 'userFirstReviewScores', 'participantCount', 'bookmarkCount', 'averageScore', 'updatedAt']));

      // 삭제: 교수님 또는 본인이 만든 자체제작/AI생성 퀴즈
      allow delete: if isProfessor() ||
        (resource.data.type in ['custom', 'ai-generated'] && resource.data.creatorId == request.auth.uid);

      // 퀴즈 제출 서브컬렉션
      match /submissions/{submissionId} {
        allow read: if isOwner(resource.data.userId) || isProfessor();
        allow create: if isAuthenticated() &&
          request.resource.data.userId == request.auth.uid;
        allow update, delete: if false;
      }

      // 서술형 채점 결과 서브컬렉션 (CF 전용 쓰기, 교수/학생 읽기)
      match /essayGrades/{gradeId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }

      // 문제별 통계 서브컬렉션 (CF 전용 쓰기)
      match /questionStats/{statId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }

    // ============================================================
    // 게시판 컬렉션
    // ============================================================

    match /posts/{postId} {
      // 읽기: 모든 로그인 사용자
      allow read: if isAuthenticated();

      // 생성: 로그인 사용자 (유효성 검증)
      allow create: if isAuthenticated() &&
        request.resource.data.authorId == request.auth.uid &&
        isValidString(request.resource.data.title, 1, 100) &&
        isValidString(request.resource.data.content, 1, 5000) &&
        request.resource.data.category in ['toProfessor', 'community'];

      // 수정: 작성자가 제목/내용 수정 OR 로그인 사용자가 좋아요/댓글수 업데이트 OR 교수님이 고정
      allow update: if isAuthenticated() && (
        // 작성자가 제목, 내용, 이미지, 파일 수정
        (isOwner(resource.data.authorId) &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['title', 'content', 'imageUrl', 'imageUrls', 'fileUrls', 'isAnonymous', 'updatedAt'])) ||
        // 로그인 사용자가 좋아요/댓글수/조회수 업데이트
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['likes', 'likedBy', 'commentCount', 'viewCount']) ||
        // 교수님이 게시글 고정/해제
        (isProfessor() &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['isPinned', 'pinnedAt', 'pinnedBy']))
      );

      // 삭제: 작성자 또는 교수님
      allow delete: if isOwner(resource.data.authorId) || isProfessor();

      // 댓글 서브컬렉션
      match /comments/{commentId} {
        allow read: if isAuthenticated();

        allow create: if isAuthenticated() &&
          request.resource.data.authorId == request.auth.uid &&
          request.resource.data.content is string &&
          request.resource.data.content.size() <= 1000;

        allow update: if isOwner(resource.data.authorId) &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['content', 'imageUrls', 'updatedAt']);

        allow delete: if isOwner(resource.data.authorId) || isProfessor();
      }
    }

    // ============================================================
    // 댓글 컬렉션 (최상위)
    // ============================================================

    match /comments/{commentId} {
      // 읽기: 모든 로그인 사용자
      allow read: if isAuthenticated();

      // 생성: 로그인 사용자 (유효성 검증, 이미지만 보낼 수도 있으므로 content 최소 0자)
      allow create: if isAuthenticated() &&
        request.resource.data.authorId == request.auth.uid &&
        request.resource.data.content is string &&
        request.resource.data.content.size() <= 1000;

      // 수정: 작성자가 내용 수정 OR 로그인 사용자가 좋아요 업데이트
      allow update: if isAuthenticated() && (
        // 작성자가 내용/이미지 수정
        (isOwner(resource.data.authorId) &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['content', 'imageUrls', 'updatedAt'])) ||
        // 로그인 사용자가 좋아요 업데이트 (likes, likedBy 필드만 변경)
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['likes', 'likedBy'])
      );

      // 삭제: 작성자 또는 교수님
      allow delete: if isOwner(resource.data.authorId) || isProfessor();
    }

    // ============================================================
    // 피드백 컬렉션
    // ============================================================

    match /feedbacks/{feedbackId} {
      // 읽기: 로그인 사용자 (퀴즈 제작자가 피드백 확인용, 민감하지 않은 데이터)
      allow read: if isAuthenticated();

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 교수님만 (답변 작성)
      allow update: if isProfessor();

      // 삭제: 불가
      allow delete: if false;
    }

    // ============================================================
    // 도배 방지 (Rate Limit) 컬렉션
    // ============================================================

    match /rateLimits/{uid} {
      allow read, write: if isOwner(uid);

      match /{type}/{recordId} {
        allow read, write: if isOwner(uid);
      }
    }

    // ============================================================
    // FCM 토큰 컬렉션
    // ============================================================

    match /fcmTokens/{tokenId} {
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow create, update: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 시즌 로그 컬렉션
    // ============================================================

    match /seasonLogs/{logId} {
      // 읽기: 교수님만
      allow read: if isProfessor();

      // 쓰기: Cloud Functions에서만
      allow write: if false;
    }

    // ============================================================
    // 알림 컬렉션
    // ============================================================

    match /notifications/{notificationId} {
      // 읽기: 본인 알림만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 수정: 본인만 (읽음 처리)
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);

      // 생성/삭제: Cloud Functions에서만
      allow create, delete: if false;
    }

    // ============================================================
    // 복습 문제 컬렉션 (오답/찜한 문제)
    // ============================================================

    match /reviews/{reviewId} {
      // 읽기: 본인 문제만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만 (복습 횟수, 마지막 복습 일시)
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 퀴즈 결과 컬렉션 (푼 문제)
    // ============================================================

    match /quizResults/{resultId} {
      // 읽기: 로그인 사용자 (통계 조회용, 민감하지 않은 데이터)
      allow read: if isAuthenticated();

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만 (피드백 여부 등)
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만 (푼 문제 폴더 삭제 시)
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 커스텀 폴더 컬렉션 (내맘대로)
    // ============================================================

    match /customFolders/{folderId} {
      // 읽기: 본인 폴더만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 문제 피드백 컬렉션
    // ============================================================

    match /questionFeedbacks/{feedbackId} {
      // 읽기: 본인 피드백, 교수님, 또는 해당 퀴즈의 제작자
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isProfessor() ||
         // 퀴즈 제작자도 피드백 확인 가능
         (resource.data.quizId != null &&
          get(/databases/$(database)/documents/quizzes/$(resource.data.quizId)).data.creatorId == request.auth.uid));

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정/삭제: 불가
      allow update, delete: if false;
    }

    // ============================================================
    // 퀴즈 진행 상황 저장 컬렉션
    // ============================================================

    match /quizProgress/{progressId} {
      // 읽기: 본인만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 퀴즈 제출 컬렉션 (최상위)
    // ============================================================

    match /submissions/{submissionId} {
      // 읽기: 본인 또는 교수님
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || isProfessor());

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정/삭제: 불가
      allow update, delete: if false;
    }

    // ============================================================
    // 퀴즈 북마크 컬렉션 (찜한 문제지)
    // ============================================================

    match /quizBookmarks/{bookmarkId} {
      // 읽기: 본인 북마크만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 본인만
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 삭제: 본인만
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 삭제된 항목 컬렉션 (휴지통)
    // ============================================================

    match /deletedReviewItems/{itemId} {
      // 읽기: 본인 항목만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: 불가 (복원은 삭제 후 재생성으로 처리)
      allow update: if false;

      // 삭제: 본인만 (복원 또는 영구 삭제 시)
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 과목 컬렉션 (읽기 전용)
    // ============================================================

    match /courses/{courseId} {
      // 읽기: 모든 로그인 사용자
      allow read: if isAuthenticated();

      // 쓰기: 교수님만
      allow write: if isProfessor();
    }

    // ============================================================
    // 설정 컬렉션 (학기 설정 등)
    // ============================================================

    match /settings/{settingId} {
      // 읽기: 모든 로그인 사용자
      allow read: if isAuthenticated();

      // 쓰기: 교수님만
      allow write: if isProfessor();
    }

    // ============================================================
    // PPTX 퀴즈 생성 작업 컬렉션
    // ============================================================

    match /quizJobs/{jobId} {
      // 읽기: 본인 작업만
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 생성: 로그인 사용자 (본인 것만)
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // 수정: Cloud Functions에서만 (클라이언트 수정 불가)
      allow update: if false;

      // 삭제: 불가 (Cloud Functions에서 정리)
      allow delete: if false;
    }

    // ============================================================
    // 퀴즈 완료 기록 (completedUsers 배열 대체)
    // Cloud Functions에서만 쓰기 (recordAttempt)
    // ============================================================

    match /quiz_completions/{docId} {
      // 읽기: 로그인 사용자 (완료 여부 확인)
      allow read: if isAuthenticated();

      // 쓰기: 본인의 완료 기록만 (userId 필드가 본인 또는 docId에 본인 uid 포함)
      allow create, update: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ============================================================
    // 퀴즈 통계 분산 카운터
    // Cloud Functions에서만 쓰기 (recordAttempt)
    // ============================================================

    match /quiz_agg/{quizId} {
      allow read: if isAuthenticated();
      allow write: if false;

      match /shards/{shardId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }

    // ============================================================
    // Rate Limit v2 (recordAttempt용)
    // Cloud Functions에서만 쓰기
    // ============================================================

    match /rateLimits_v2/{docId} {
      allow read: if false;
      allow write: if false;
    }

    // ============================================================
    // AI 문제 생성 Jobs (CF 전용 쓰기, 본인 읽기)
    // ============================================================
    match /jobs/{jobId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false; // CF에서만 쓰기
    }

    // ============================================================
    // Material 캐시 (CF 전용, 클라이언트 접근 불가)
    // ============================================================
    match /materials/{fingerprint} {
      allow read: if false;
      allow write: if false;
    }

    // ============================================================
    // 공지 채널 (교수님 작성, 학생 읽기/리액션)
    // ============================================================
    match /announcements/{announcementId} {
      // 읽기: 로그인 사용자
      allow read: if isAuthenticated();

      // 생성: 교수님만
      allow create: if isProfessor();

      // 수정: 교수님 (내용 수정) 또는 로그인 사용자 (리액션/투표)
      allow update: if isAuthenticated() && (
        isProfessor() ||
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['reactions', 'poll.votes', 'polls', 'readBy'])
      );

      // 삭제: 교수님만
      allow delete: if isProfessor();
    }

    // ============================================================
    // 랭킹 사전 계산 결과 (CF 전용 쓰기)
    // ============================================================
    match /rankings/{courseId} {
      // 읽기: 로그인 사용자
      allow read: if isAuthenticated();
      // 쓰기: Cloud Functions에서만
      allow write: if false;
    }

    // ============================================================
    // 캐릭터 도감 (레거시 — 읽기 전용 보존)
    // ============================================================
    match /characterDiscoveries/{discoveryId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ============================================================
    // 토끼 컬렉션 (CF 전용 쓰기)
    // ============================================================
    match /rabbits/{rabbitDocId} {
      // 읽기: 로그인 사용자 (도감 조회)
      allow read: if isAuthenticated();
      // 쓰기: Cloud Functions에서만
      allow write: if false;
    }

    // rabbit_successors: 레거시 (승계 모델 제거됨)
    // 마이그레이션 완료 후 삭제 예정

    // ============================================================
    // 토끼 보유 서브컬렉션 (users/{uid}/rabbitHoldings)
    // ============================================================
    // users/{uid} 하위에 이미 정의되어 있으므로 아래 참고

    // ============================================================
    // 비공개 퀴즈 (자체제작 퀴즈 폴백 조회)
    // ============================================================
    match /privateQuizzes/{quizId} {
      // 읽기: 로그인 사용자
      allow read: if isAuthenticated();

      // 쓰기: 불가 (Cloud Functions 또는 다른 경로에서 관리)
      allow write: if false;
    }

    // ============================================================
    // 좋아요 컬렉션 (CF 트리거용)
    // ============================================================
    match /likes/{likeId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow update: if false;
    }

    // ============================================================
    // Cloud Functions 전용 컬렉션 (클라이언트 접근 차단)
    // ============================================================

    // 알림 히스토리
    match /notificationHistory/{docId} {
      allow read, write: if false;
    }

    // 학기 전환 로그
    match /semesterTransitionLogs/{logId} {
      allow read: if isProfessor();
      allow write: if false;
    }

    // 과목 Scope (AI 문제 생성용 범위 데이터)
    match /courseScopes/{courseId} {
      allow read: if isAuthenticated();
      allow write: if false;

      match /chapters/{chapterId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }

    // 교수 퀴즈 스타일 분석
    match /professorQuizAnalysis/{courseId} {
      allow read: if isAuthenticated();
      allow write: if false;

      match /raw/{quizId} {
        allow read, write: if false;
      }

      match /data/{dataId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }

    // Gemini 사용량 추적
    match /geminiUsage/{path=**} {
      allow read, write: if false;
    }

    // Gemini 큐
    match /geminiQueue/{docId} {
      allow read, write: if false;
    }

    // OCR 사용량 추적
    match /ocrUsage/{path=**} {
      allow read, write: if false;
    }

    // Vision OCR 사용량 추적
    match /visionOcrUsage/{path=**} {
      allow read, write: if false;
    }

    // 스타일 기반 AI 문제 생성 사용량
    match /styledQuizUsage/{path=**} {
      allow read, write: if false;
    }
  }
}
